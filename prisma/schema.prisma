// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                @id @default(cuid())
  name                String?
  email               String                @unique
  password            String?
  emailVerified       DateTime?
  role                UserRole              @default(user)
  image               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  isActive            Boolean               @default(true)
  lastLogin           DateTime?
  phone               String?
  isAdmin             Boolean               @default(false)
  isVerified          Boolean               @default(false) 
  verificationToken   String?               
  accounts            Account[]
  documentLogs        DocumentLog[]
  permohonanAhliWaris PermohonanAhliWaris[]
  profile             Profile?
  sessions            Session[]
  suratPernyataan     SuratPernyataan[]
  notifications       Notification[]        
  activityLogs        ActivityLog[]         

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  ipAddress    String?  
  userAgent    String? 
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@index([expires])
}

model PermohonanAhliWaris {
  id                    String           @id @default(cuid())
  userId                String?
  email                 String
  nomorTelepon          String?
  namaPemohon           String
  nikPemohon            String
  alamatPemohon         String
  hubunganDenganPewaris String
  namaPewaris           String
  nikPewaris            String
  alamatPewaris         String
  tanggalMeninggal      DateTime
  statusPernikahan      String
  daftarAhliWaris       Json
  createdAt             DateTime         @default(now())
  statusPermohonan      StatusPermohonan @default(PENDING)
  agamaPewaris          String?
  catatan          String?
  instansiNikah         String?
  noSuratNikah          String?
  nomorAkteKematian     String?
  pekerjaanPewaris      String?
  suratPernyataanId     String?          @unique
  tanggalAkteKematian   DateTime?
  tanggalLahirPewaris   DateTime?
  tanggalNikah          DateTime?
  tempatLahirPewaris    String?
  updatedAt             DateTime         @updatedAt
  completedAt           DateTime?        
  suratPernyataan       SuratPernyataan? @relation(fields: [suratPernyataanId], references: [id])
  user                  User?            @relation(fields: [userId], references: [id])

  @@index([statusPermohonan])
  @@index([userId])
  @@index([createdAt])
  @@index([completedAt])
}

model Profile {
  id           String    @id @default(cuid())
  userId       String    @unique
  alamat       String?
  nomorTelepon String?
  tanggalLahir DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  agama        String?
  nik          String?   @unique 
  pekerjaan    String?
  tempatLahir  String?   
  jenisKelamin String?   
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([nik])
}

// MODEL UTAMA SURAT PERNYATAAN - DIPERBARUI
model SuratPernyataan {
  id                   String               @id @default(cuid())
  nomorSurat           String               @unique
  userId               String
  
  // Data Pewaris
  dataPewaris          Json                 // Menyimpan semua data pewaris sebagai JSON
  
  // Data Ahli Waris
  ahliWaris            Json                 // Array ahli waris sebagai JSON
  
  // Data Tambahan (untuk kondisi 2 dan 3)
  anakMeninggal        Json?                // Data anak yang meninggal (untuk kondisi 2 dan 3)
  
  // Informasi Kondisi
  kondisi              String               // kondisi1, kondisi2, ..., kondisi7
  
  // Informasi Tambahan
  tambahanKeterangan   String?
  
  // Informasi Pernikahan Kedua (untuk kondisi 4)
  noSuratNikahKedua    String?
  tanggalNikahKedua    DateTime?
  instansiNikahKedua   String?
  
  // Status dan Tracking
  status               StatusSurat          @default(DRAFT)
  isGenerated          Boolean              @default(false)
  generatedAt          DateTime?
  pdfFileName          String?
  pdfFileSize          Int?
  pdfUrl               String?
  pdfVersion           Int                  @default(0)
  can_access_permohonan  Boolean              @default(false)
  catatan              String?

  // Review
  reviewNotes          String?
  reviewedBy           String?
  reviewedAt           DateTime?
  completedAt          DateTime?
  approvedAt           DateTime?
  verifiedAt           DateTime?
  submittedAt          DateTime?
  
  // Download dan Print Tracking
  downloadCount        Int                  @default(0)
  printCount           Int                  @default(0)
  lastPrinted          DateTime?
  lastDownloaded       DateTime?
  
  // Metadata
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  
  // Relations
  documentLogs         DocumentLog[]
  permohonan           PermohonanAhliWaris?
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([nomorSurat])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([kondisi])
}

model DocumentLog {
  id                String          @id @default(cuid())
  suratPernyataanId String
  userId            String?
  action            DocumentAction
  details           String?
  ipAddress         String?
  userAgent         String?
  metadata          Json?
  createdAt         DateTime        @default(now())
  suratPernyataan   SuratPernyataan @relation(fields: [suratPernyataanId], references: [id], onDelete: Cascade)
  user              User?           @relation(fields: [userId], references: [id])

  @@index([suratPernyataanId])
  @@index([action])
  @@index([createdAt])
  @@index([userId])
}

model Notification {
  id          String        @id @default(cuid())
  userId      String
  title       String
  message     String
  type        NotificationType @default(INFO)
  isRead      Boolean       @default(false)
  readAt      DateTime?
  link        String?       
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model ActivityLog {
  id          String        @id @default(cuid())
  userId      String
  action      String
  details     String?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Template {
  id          String        @id @default(cuid())
  name        String        @unique
  type        TemplateType
  subject     String?
  content     String
  variables   Json?         
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String?
  updatedBy   String?

  @@index([type])
  @@index([isActive])
}

model SystemConfig {
  id          String        @id @default(cuid())
  key         String        @unique
  value       String
  type        ConfigType    @default(STRING)
  category    String?       
  description String?
  isPublic    Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([key])
  @@index([category])
}

model BackupLog {
  id          String        @id @default(cuid())
  type        BackupType
  filename    String
  fileSize    Int?
  status      BackupStatus  @default(COMPLETED)
  details     String?
  createdAt   DateTime      @default(now())
  createdBy   String?
  
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

// ENUMS
enum UserRole {
  user
  admin
  super_admin
  reviewer  
}

enum StatusPermohonan {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED  
}

enum StatusSurat {
  DRAFT
  SUBMITTED
  VERIFIED
  APPROVED
  REJECTED
  ARCHIVED
  EXPIRED 
  COMPLETED  
}

enum DocumentAction {
  CREATE
  UPDATE
  DOWNLOAD
  VIEW
  PRINT
  GENERATE_PDF
  DELETE
  STATUS_CHANGE
  ARCHIVE    
  RESTORE    
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

enum TemplateType {
  EMAIL_APPROVAL
  EMAIL_REJECTION
  EMAIL_VERIFICATION
  SURAT_TEMPLATE
  PDF_TEMPLATE
  SMS_NOTIFICATION
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  ARRAY
}

enum BackupType {
  DATABASE
  FILES
  LOGS
  FULL
}

enum BackupStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}